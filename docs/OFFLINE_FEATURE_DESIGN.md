# 오프라인 기능 설계 문서

## 개요
비행 중이나 네트워크 연결이 없는 환경에서도 사용자가 데이터를 확인하고 일부 작업을 수행할 수 있도록 오프라인 기능을 구현합니다.

## 아키텍처

### 1. 로컬 데이터베이스 (SQLite)
- **목적**: 오프라인 상태에서 데이터를 저장하고 조회
- **저장 데이터**:
  - 사용자의 비행 정보 (MyFlights)
  - 리뷰 데이터 (캐시)
  - 시차적응 계획
  - 사용자 프로필 정보

### 2. 오프라인 큐 시스템
- **목적**: 네트워크가 없을 때 생성/수정/삭제 요청을 큐에 저장
- **동작 방식**:
  1. 네트워크 상태 확인
  2. 오프라인 시 → 로컬 큐에 저장
  3. 온라인 복구 시 → 큐의 요청을 순차적으로 동기화

### 3. 네트워크 상태 감지
- **방법**: 
  - Firebase 연결 상태 모니터링
  - 주기적인 헬스체크 (선택적)
- **상태**: `online`, `offline`, `syncing`

### 4. 동기화 전략
- **자동 동기화**: 네트워크 복구 시 자동으로 큐 처리
- **수동 동기화**: 사용자가 요청 시 즉시 동기화 시도
- **충돌 해결**: 최신 데이터 우선 (Last-Write-Wins)

## 데이터 흐름

### 읽기 작업 (조회)
```
1. 네트워크 상태 확인
2. 온라인 → Firestore에서 조회 + 로컬 캐시 업데이트
3. 오프라인 → 로컬 DB에서 조회
4. 로컬에 없으면 → "오프라인 상태에서 데이터를 찾을 수 없습니다" 반환
```

### 쓰기 작업 (생성/수정/삭제)
```
1. 네트워크 상태 확인
2. 온라인 → Firestore에 직접 저장
3. 오프라인 → 로컬 DB에 저장 + 오프라인 큐에 추가
4. 네트워크 복구 시 → 큐의 작업을 순차적으로 Firestore에 동기화
```

## 구현 컴포넌트

### 1. `app/core/offline/` 디렉토리
- `local_db.py`: SQLite 데이터베이스 관리
- `network_monitor.py`: 네트워크 상태 감지
- `sync_queue.py`: 오프라인 큐 관리 및 동기화
- `cache_service.py`: 데이터 캐싱 로직

### 2. 데이터 모델
- 로컬 DB 스키마 정의
- Firestore 데이터와의 매핑

### 3. 서비스 레이어 수정
- 기존 서비스에 오프라인 지원 추가
- 읽기: 로컬 DB 우선 조회 → 없으면 Firestore
- 쓰기: 네트워크 상태에 따라 분기

## 주요 기능

### 1. 비행 정보 오프라인 조회
- 사용자의 비행 일정을 로컬에 저장
- 오프라인에서도 비행 정보 확인 가능

### 2. 리뷰 작성 오프라인 지원
- 오프라인에서 리뷰 작성 → 로컬 저장
- 온라인 복구 시 자동 업로드

### 3. 시차적응 계획 오프라인 조회
- 생성된 계획을 로컬에 저장
- 오프라인에서도 계획 확인 가능

### 4. 동기화 상태 표시
- 현재 동기화 상태 API 제공
- 대기 중인 작업 수 확인

## 제한사항

1. **LLM 기능**: 오프라인에서는 LLM 기반 기능(리뷰 요약, 시차적응 계획 생성) 사용 불가
2. **실시간 데이터**: 오프라인에서는 최신 데이터가 아닐 수 있음
3. **이미지 업로드**: 오프라인에서 작성한 리뷰의 이미지는 온라인 복구 후 업로드

## 보안 고려사항

1. 로컬 DB 암호화 (선택적)
2. 오프라인 큐의 데이터 무결성 검증
3. 동기화 시 인증 토큰 재검증

